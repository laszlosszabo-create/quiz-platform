<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Editor - Translation Tab (Native)</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <div class="max-w-6xl mx-auto p-4">
        <!-- Header -->
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-gray-900">üåê Ford√≠t√°sok szerkeszt≈ë</h2>
            
            <!-- Language switcher -->
            <div class="flex bg-gray-100 rounded-lg p-1">
                <button id="btn-hu" class="px-3 py-1 rounded text-sm font-medium bg-white text-gray-900 shadow-sm">
                    üá≠üá∫ Magyar
                </button>
                <button id="btn-en" class="px-3 py-1 rounded text-sm font-medium text-gray-600 hover:text-gray-900">
                    üá¨üáß Angol
                </button>
            </div>
        </div>

        <!-- Translation sections -->
        <div id="translation-sections"></div>

        <!-- Status and Actions -->
        <div class="fixed bottom-4 right-4 flex items-center gap-3 bg-white border border-gray-300 rounded-lg shadow-lg p-3">
            <span id="status" class="text-sm text-green-700">Mentve</span>
            <button id="btn-save" class="px-3 py-2 rounded-md bg-blue-600 text-white disabled:opacity-50" disabled>
                Ment√©s
            </button>
        </div>
    </div>

    <script>
        // Get quiz ID from URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const quizId = urlParams.get('id');
        
        let currentLang = 'hu';
        let dirty = false;
        let translations = { hu: {}, en: {} };
        
        // Teljes ford√≠t√°si mez≈ëlista (Landing LP + legacy + egy√©b)
        const translationFields = [
            // Hero szekci√≥
            { key: 'landing_hero_title', label: 'Hero: F≈ëc√≠m', category: 'Hero szekci√≥', multiline: true },
            { key: 'landing_hero_sub', label: 'Hero: Alc√≠m', category: 'Hero szekci√≥', multiline: true },
            { key: 'landing_hero_note', label: 'Hero: Apr√≥ sz√∂veg CTA alatt', category: 'Hero szekci√≥' },
            { key: 'landing_badge_1', label: 'Hero: Badge 1', category: 'Hero szekci√≥' },
            { key: 'landing_badge_2', label: 'Hero: Badge 2', category: 'Hero szekci√≥' },
            { key: 'landing_badge_3', label: 'Hero: Badge 3', category: 'Hero szekci√≥' },
            { key: 'landing_time_estimate', label: 'Hero: Becs√ºlt id≈ë', category: 'Hero szekci√≥' },
            { key: 'landing_question_count', label: 'Hero: K√©rd√©sek sz√°ma', category: 'Hero szekci√≥' },
            
            // CTA gombok
            { key: 'landing_cta_primary', label: 'CTA: F≈ëgomb sz√∂vege', category: 'CTA gombok' },
            { key: 'landing_cta_secondary', label: 'CTA: Mell√©kgomb sz√∂vege', category: 'CTA gombok' },
            { key: 'landing_cta_mid', label: 'CTA: K√∂z√©ps≈ë gomb', category: 'CTA gombok' },
            { key: 'landing_cta_urgency', label: 'CTA: Urgencia szekci√≥ gomb', category: 'CTA gombok' },
            { key: 'landing_final_cta_button', label: 'CTA: Utols√≥ gomb', category: 'CTA gombok' },

            // Statisztik√°k szekci√≥
            { key: 'landing_stats_title', label: 'Statisztik√°k: Szekci√≥ c√≠m', category: 'Statisztik√°k' },
            { key: 'landing_stats_desc', label: 'Statisztik√°k: Szekci√≥ le√≠r√°s', category: 'Statisztik√°k' },
            { key: 'landing_stat_1_number', label: 'Statisztik√°k: 1. sz√°m', category: 'Statisztik√°k' },
            { key: 'landing_stat_1_label', label: 'Statisztik√°k: 1. c√≠mke', category: 'Statisztik√°k' },
            { key: 'landing_stat_2_number', label: 'Statisztik√°k: 2. sz√°m', category: 'Statisztik√°k' },
            { key: 'landing_stat_2_label', label: 'Statisztik√°k: 2. c√≠mke', category: 'Statisztik√°k' },
            { key: 'landing_stat_3_number', label: 'Statisztik√°k: 3. sz√°m', category: 'Statisztik√°k' },
            { key: 'landing_stat_3_label', label: 'Statisztik√°k: 3. c√≠mke', category: 'Statisztik√°k' },
            { key: 'landing_stat_4_number', label: 'Statisztik√°k: 4. sz√°m', category: 'Statisztik√°k' },
            { key: 'landing_stat_4_label', label: 'Statisztik√°k: 4. c√≠mke', category: 'Statisztik√°k' },

            // Trust/El≈ëny√∂k szekci√≥
            { key: 'landing_trust_section_title', label: 'Trust: Szekci√≥ c√≠m', category: 'Trust/El≈ëny√∂k' },
            { key: 'landing_trust_section_desc', label: 'Trust: Szekci√≥ le√≠r√°s', category: 'Trust/El≈ëny√∂k', multiline: true },
            { key: 'landing_trust_item_1_title', label: 'Trust: 1. el≈ëny c√≠me', category: 'Trust/El≈ëny√∂k' },
            { key: 'landing_trust_item_1_desc', label: 'Trust: 1. el≈ëny le√≠r√°sa', category: 'Trust/El≈ëny√∂k', multiline: true },
            { key: 'landing_trust_item_2_title', label: 'Trust: 2. el≈ëny c√≠me', category: 'Trust/El≈ëny√∂k' },
            { key: 'landing_trust_item_2_desc', label: 'Trust: 2. el≈ëny le√≠r√°sa', category: 'Trust/El≈ëny√∂k', multiline: true },
            { key: 'landing_trust_item_3_title', label: 'Trust: 3. el≈ëny c√≠me', category: 'Trust/El≈ëny√∂k' },
            { key: 'landing_trust_item_3_desc', label: 'Trust: 3. el≈ëny le√≠r√°sa', category: 'Trust/El≈ëny√∂k', multiline: true },

            // Hogyan m≈±k√∂dik szekci√≥
            { key: 'landing_how_section_title', label: 'Hogyan: Szekci√≥ c√≠m', category: 'Hogyan m≈±k√∂dik' },
            { key: 'landing_how_section_desc', label: 'Hogyan: Szekci√≥ le√≠r√°s', category: 'Hogyan m≈±k√∂dik', multiline: true },
            { key: 'landing_how_1_title', label: 'Hogyan: 1. l√©p√©s c√≠m', category: 'Hogyan m≈±k√∂dik' },
            { key: 'landing_how_1_desc', label: 'Hogyan: 1. l√©p√©s le√≠r√°s', category: 'Hogyan m≈±k√∂dik', multiline: true },
            { key: 'landing_how_2_title', label: 'Hogyan: 2. l√©p√©s c√≠m', category: 'Hogyan m≈±k√∂dik' },
            { key: 'landing_how_2_desc', label: 'Hogyan: 2. l√©p√©s le√≠r√°s', category: 'Hogyan m≈±k√∂dik', multiline: true },
            { key: 'landing_how_3_title', label: 'Hogyan: 3. l√©p√©s c√≠m', category: 'Hogyan m≈±k√∂dik' },
            { key: 'landing_how_3_desc', label: 'Hogyan: 3. l√©p√©s le√≠r√°s', category: 'Hogyan m≈±k√∂dik', multiline: true },

            // Mire sz√°m√≠thatsz szekci√≥  
            { key: 'landing_expect_title', label: 'Elv√°r√°sok: Szekci√≥ c√≠m', category: 'Mire sz√°m√≠thatsz' },
            { key: 'landing_expect_desc', label: 'Elv√°r√°sok: Szekci√≥ le√≠r√°s', category: 'Mire sz√°m√≠thatsz', multiline: true },
            { key: 'landing_expect_1_title', label: 'Elv√°r√°sok: 1. elem c√≠m', category: 'Mire sz√°m√≠thatsz' },
            { key: 'landing_expect_1_desc', label: 'Elv√°r√°sok: 1. elem le√≠r√°s', category: 'Mire sz√°m√≠thatsz', multiline: true },
            { key: 'landing_expect_2_title', label: 'Elv√°r√°sok: 2. elem c√≠m', category: 'Mire sz√°m√≠thatsz' },
            { key: 'landing_expect_2_desc', label: 'Elv√°r√°sok: 2. elem le√≠r√°s', category: 'Mire sz√°m√≠thatsz', multiline: true },
            { key: 'landing_expect_3_title', label: 'Elv√°r√°sok: 3. elem c√≠m', category: 'Mire sz√°m√≠thatsz' },
            { key: 'landing_expect_3_desc', label: 'Elv√°r√°sok: 3. elem le√≠r√°s', category: 'Mire sz√°m√≠thatsz', multiline: true },
            { key: 'landing_expect_4_title', label: 'Elv√°r√°sok: 4. elem c√≠m', category: 'Mire sz√°m√≠thatsz' },
            { key: 'landing_expect_4_desc', label: 'Elv√°r√°sok: 4. elem le√≠r√°s', category: 'Mire sz√°m√≠thatsz', multiline: true },

            // Urgencia szekci√≥
            { key: 'landing_urgency_title', label: 'Urgencia: Szekci√≥ c√≠m', category: 'Urgencia' },
            { key: 'landing_urgency_desc', label: 'Urgencia: Szekci√≥ le√≠r√°s', category: 'Urgencia', multiline: true },
            { key: 'landing_urgency_point_1', label: 'Urgencia: 1. pont', category: 'Urgencia', multiline: true },
            { key: 'landing_urgency_point_2', label: 'Urgencia: 2. pont', category: 'Urgencia', multiline: true },
            { key: 'landing_urgency_point_3', label: 'Urgencia: 3. pont', category: 'Urgencia', multiline: true },

            // Garanci√°k szekci√≥
            { key: 'landing_guarantee_title', label: 'Garanci√°k: Szekci√≥ c√≠m', category: 'Garanci√°k' },
            { key: 'landing_guarantee_1', label: 'Garanci√°k: 1. garancia', category: 'Garanci√°k' },
            { key: 'landing_guarantee_2', label: 'Garanci√°k: 2. garancia', category: 'Garanci√°k' },
            { key: 'landing_guarantee_3', label: 'Garanci√°k: 3. garancia', category: 'Garanci√°k' },
            { key: 'landing_guarantee_4', label: 'Garanci√°k: 4. garancia', category: 'Garanci√°k' },

            // Aj√°nl√°sok/Testimonials (opcion√°lis)
            { key: 'landing_testimonial_1_quote', label: 'Aj√°nl√°s: 1. id√©zet', category: 'Aj√°nl√°sok', multiline: true },
            { key: 'landing_testimonial_1_author', label: 'Aj√°nl√°s: 1. szerz≈ë', category: 'Aj√°nl√°sok' },
            { key: 'landing_testimonial_2_quote', label: 'Aj√°nl√°s: 2. id√©zet', category: 'Aj√°nl√°sok', multiline: true },
            { key: 'landing_testimonial_2_author', label: 'Aj√°nl√°s: 2. szerz≈ë', category: 'Aj√°nl√°sok' },
            { key: 'landing_testimonial_3_quote', label: 'Aj√°nl√°s: 3. id√©zet', category: 'Aj√°nl√°sok', multiline: true },
            { key: 'landing_testimonial_3_author', label: 'Aj√°nl√°s: 3. szerz≈ë', category: 'Aj√°nl√°sok' },

            // GYIK (opcion√°lis)
            { key: 'landing_faq_section_title', label: 'GYIK: Szekci√≥ c√≠m', category: 'GYIK' },
            { key: 'landing_faq_1_q', label: 'GYIK: 1. k√©rd√©s', category: 'GYIK' },
            { key: 'landing_faq_1_a', label: 'GYIK: 1. v√°lasz', category: 'GYIK', multiline: true },
            { key: 'landing_faq_2_q', label: 'GYIK: 2. k√©rd√©s', category: 'GYIK' },
            { key: 'landing_faq_2_a', label: 'GYIK: 2. v√°lasz', category: 'GYIK', multiline: true },
            { key: 'landing_faq_3_q', label: 'GYIK: 3. k√©rd√©s', category: 'GYIK' },
            { key: 'landing_faq_3_a', label: 'GYIK: 3. v√°lasz', category: 'GYIK', multiline: true },
            { key: 'landing_faq_4_q', label: 'GYIK: 4. k√©rd√©s', category: 'GYIK' },
            { key: 'landing_faq_4_a', label: 'GYIK: 4. v√°lasz', category: 'GYIK', multiline: true },
            { key: 'landing_faq_5_q', label: 'GYIK: 5. k√©rd√©s', category: 'GYIK' },
            { key: 'landing_faq_5_a', label: 'GYIK: 5. v√°lasz', category: 'GYIK', multiline: true },
            { key: 'landing_faq_6_q', label: 'GYIK: 6. k√©rd√©s', category: 'GYIK' },
            { key: 'landing_faq_6_a', label: 'GYIK: 6. v√°lasz', category: 'GYIK', multiline: true },

            // Adatv√©delem szekci√≥
            { key: 'landing_privacy_title', label: 'Adatv√©delem: Szekci√≥ c√≠m', category: 'Adatv√©delem' },
            { key: 'landing_privacy_desc', label: 'Adatv√©delem: Szekci√≥ le√≠r√°s', category: 'Adatv√©delem', multiline: true },
            { key: 'landing_privacy_point_1', label: 'Adatv√©delem: 1. pont', category: 'Adatv√©delem', multiline: true },
            { key: 'landing_privacy_point_2', label: 'Adatv√©delem: 2. pont', category: 'Adatv√©delem', multiline: true },
            { key: 'landing_privacy_point_3', label: 'Adatv√©delem: 3. pont', category: 'Adatv√©delem', multiline: true },
            { key: 'landing_privacy_point_4', label: 'Adatv√©delem: 4. pont', category: 'Adatv√©delem', multiline: true },

            // Orvosi disclaimer
            { key: 'landing_medical_title', label: 'Orvosi: Szekci√≥ c√≠m', category: 'Orvosi disclaimer' },
            { key: 'landing_medical_point_1', label: 'Orvosi: 1. pont', category: 'Orvosi disclaimer', multiline: true },
            { key: 'landing_medical_point_2', label: 'Orvosi: 2. pont', category: 'Orvosi disclaimer', multiline: true },
            { key: 'landing_medical_point_3', label: 'Orvosi: 3. pont', category: 'Orvosi disclaimer', multiline: true },
            { key: 'landing_medical_point_4', label: 'Orvosi: 4. pont', category: 'Orvosi disclaimer', multiline: true },
            { key: 'landing_disclaimer', label: 'Orvosi: F≈ësz√∂veg', category: 'Orvosi disclaimer', multiline: true },

            // Utols√≥ CTA szekci√≥
            { key: 'landing_final_cta_title', label: 'Utols√≥ CTA: C√≠m', category: 'Utols√≥ CTA' },
            { key: 'landing_final_cta_desc', label: 'Utols√≥ CTA: Le√≠r√°s', category: 'Utols√≥ CTA', multiline: true },

            // SEO Metadata
            { key: 'meta_title', label: 'SEO: Oldal c√≠me', category: 'SEO' },
            { key: 'meta_description', label: 'SEO: Oldal le√≠r√°sa', category: 'SEO', multiline: true },

            // Legacy/√°ltal√°nos Landing Page mez≈ëk (kompatibilit√°s)
            { key: 'landing_headline', label: 'Legacy: Landing headline', category: 'Legacy' },
            { key: 'landing_sub', label: 'Legacy: Landing alc√≠m', category: 'Legacy' },
            { key: 'landing_description', label: 'Landing le√≠r√°s', category: 'Landing Page', multiline: true },
            { key: 'landing_cta_text', label: 'Landing CTA sz√∂veg', category: 'Landing Page' },
            { key: 'meta_title', label: 'Meta title (SEO)', category: 'Landing Page' },
            { key: 'meta_description', label: 'Meta description (SEO)', category: 'Landing Page', multiline: true },

            // Email Gate (aktu√°lis kulcsok)
            { key: 'email_gate_headline', label: 'Email gate headline', category: 'Email Gate' },
            { key: 'email_gate_description', label: 'Email gate le√≠r√°s', category: 'Email Gate', multiline: true },
            { key: 'email_field_placeholder', label: 'Email mez≈ë placeholder', category: 'Email Gate' },
            { key: 'name_field_placeholder', label: 'N√©v mez≈ë placeholder', category: 'Email Gate' },
            { key: 'email_gate_submit_button', label: 'Submit gomb sz√∂veg', category: 'Email Gate' },
            { key: 'email_gate_privacy_text', label: 'Adatv√©delmi sz√∂veg', category: 'Email Gate', multiline: true },

            // Social Proof (egyszer≈±)
            { key: 'social_proof_1', label: 'Social proof 1', category: 'Social Proof' },
            { key: 'social_proof_2', label: 'Social proof 2', category: 'Social Proof' },
            { key: 'social_proof_3', label: 'Social proof 3', category: 'Social Proof' },

            // Result Page (mint√°k)
            { key: 'result_headline', label: 'Eredm√©ny headline', category: 'Result Page' },
            { key: 'result_sub', label: 'Eredm√©ny alc√≠m', category: 'Result Page' },
            { key: 'result_ai_loading', label: 'AI loading sz√∂veg', category: 'Result Page' },
            { key: 'result_booking_headline', label: 'Foglal√°s headline', category: 'Result Page' },
            { key: 'result_booking_cta', label: 'Foglal√°s gomb', category: 'Result Page' },
            { key: 'result_product_headline', label: 'Term√©k headline', category: 'Result Page' },
            { key: 'result_product_cta', label: 'Term√©k gomb', category: 'Result Page' },
        ];

        // Group fields by category
        const categorizedFields = translationFields.reduce((acc, field) => {
            if (!acc[field.category]) acc[field.category] = [];
            acc[field.category].push(field);
            return acc;
        }, {});

        // Elements
        const btnHu = document.getElementById('btn-hu');
        const btnEn = document.getElementById('btn-en');
        const btnSave = document.getElementById('btn-save');
        const status = document.getElementById('status');
        const sectionsContainer = document.getElementById('translation-sections');

        // Load translations
        async function loadTranslations() {
            try {
                const response = await fetch(`/api/admin/quizzes/${quizId}`);
                if (!response.ok) throw new Error('Failed to load quiz');
                
                const data = await response.json();
                translations = data.translations || { hu: {}, en: {} };
                
                renderFields();
                setClean();
            } catch (error) {
                console.error('Error loading translations:', error);
                alert('Hiba a ford√≠t√°sok bet√∂lt√©sekor: ' + error.message);
            }
        }

        // Save translations
        async function saveTranslations() {
            if (!dirty) return;
            
            try {
                // Collect all field values
                translationFields.forEach(field => {
                    const input = document.getElementById(`field-${field.key}`);
                    if (input && input.value !== undefined) {
                        if (!translations[currentLang]) translations[currentLang] = {};
                        translations[currentLang][field.key] = input.value;
                    }
                });

                const response = await fetch(`/api/admin/quizzes/${quizId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ translations })
                });

                if (!response.ok) throw new Error('Failed to save');
                
                setClean();
                
                // Notify parent component if embedded
                if (window.parent && window.parent !== window) {
                    window.parent.postMessage({ 
                        type: 'translationsSaved', 
                        translations: translations 
                    }, '*');
                }
                
                alert('Ford√≠t√°sok elmentve!');
            } catch (error) {
                console.error('Error saving translations:', error);
                alert('Ment√©si hiba: ' + error.message);
            }
        }

        // Render form fields
        function renderFields() {
            sectionsContainer.innerHTML = '';
            
            Object.entries(categorizedFields).forEach(([category, fields]) => {
                const section = document.createElement('div');
                section.className = 'bg-white rounded-lg border border-gray-200 shadow-sm mb-6';
                
                section.innerHTML = `
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-medium text-gray-900">${category}</h3>
                    </div>
                    <div class="p-6 space-y-4">
                        ${fields.map(field => createFieldHTML(field)).join('')}
                    </div>
                `;
                
                sectionsContainer.appendChild(section);
            });
            
            // Add event listeners
            translationFields.forEach(field => {
                const input = document.getElementById(`field-${field.key}`);
                if (input) {
                    input.addEventListener('input', () => onFieldChange(field.key));
                }
            });
        }

        // Create HTML for a single field
        function createFieldHTML(field) {
            const currentValue = translations[currentLang]?.[field.key] || '';
            const isMissing = !currentValue.trim();
            
            return `
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700">
                        ${field.label}
                        ${isMissing ? '<span class="ml-2 text-orange-500">‚ö†Ô∏è</span>' : ''}
                    </label>
                    ${field.multiline ? `
                        <textarea
                            id="field-${field.key}"
                            rows="3"
                            class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 ${isMissing ? 'border-orange-300 bg-orange-50' : 'border-gray-300'}"
                            placeholder="${field.label} ${currentLang.toUpperCase()} nyelven..."
                        >${currentValue}</textarea>
                    ` : `
                        <input
                            type="text"
                            id="field-${field.key}"
                            value="${currentValue}"
                            class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 ${isMissing ? 'border-orange-300 bg-orange-50' : 'border-gray-300'}"
                            placeholder="${field.label} ${currentLang.toUpperCase()} nyelven..."
                        />
                    `}
                </div>
            `;
        }

        // Mark field as changed
        function onFieldChange(fieldKey) {
            dirty = true;
            updateUI();
        }

        // Update UI
        function updateUI() {
            status.textContent = dirty ? 'Nem mentett m√≥dos√≠t√°sok' : 'Mentve';
            status.className = dirty ? 
                'text-sm text-amber-700' : 'text-sm text-green-700';
            
            btnSave.disabled = !dirty;
        }

        // Set clean state
        function setClean() {
            dirty = false;
            updateUI();
        }

        // Switch language
        function switchLanguage(lang) {
            if (dirty && !confirm('Nem mentett m√≥dos√≠t√°sok vannak. Elmentsem most?')) {
                return;
            }
            if (dirty) {
                saveTranslations();
                return;
            }
            
            currentLang = lang;
            
            // Update button styles
            if (lang === 'hu') {
                btnHu.className = 'px-3 py-1 rounded text-sm font-medium bg-white text-gray-900 shadow-sm';
                btnEn.className = 'px-3 py-1 rounded text-sm font-medium text-gray-600 hover:text-gray-900';
            } else {
                btnEn.className = 'px-3 py-1 rounded text-sm font-medium bg-white text-gray-900 shadow-sm';
                btnHu.className = 'px-3 py-1 rounded text-sm font-medium text-gray-600 hover:text-gray-900';
            }
            
            renderFields();
        }

        // Event listeners
        btnHu.addEventListener('click', () => switchLanguage('hu'));
        btnEn.addEventListener('click', () => switchLanguage('en'));
        btnSave.addEventListener('click', saveTranslations);

        // --- Iframe auto-resize: report height to parent ---
        function postHeight() {
            try {
                const body = document.body;
                const html = document.documentElement;
                const height = Math.max(
                    body.scrollHeight, body.offsetHeight,
                    html.clientHeight, html.scrollHeight, html.offsetHeight
                );
                if (window.parent && window.parent !== window) {
                    window.parent.postMessage({ type: 'native-editor:height', height }, window.location.origin);
                }
            } catch (e) { /* noop */ }
        }

        const heightObserver = new ResizeObserver(() => postHeight());
        heightObserver.observe(document.body);
        window.addEventListener('load', postHeight);
        window.addEventListener('resize', postHeight);

        // Initial load
        if (quizId) {
            loadTranslations().then(() => setTimeout(postHeight, 0));
        } else {
            alert('Quiz ID not found in URL parameters');
        }
    </script>
</body>
</html>
