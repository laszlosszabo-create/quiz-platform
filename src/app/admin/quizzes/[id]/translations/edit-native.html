<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Translation Editor - Native</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <div class="max-w-4xl mx-auto p-6">
        <div class="mb-6">
            <h1 class="text-2xl font-bold text-gray-900">Fordítás kezelés (Native)</h1>
            <p class="text-gray-600 mt-1">
                Tiszta HTML/JS implementáció - nincs React interferencia
            </p>
        </div>

        <!-- Language Switcher -->
        <div class="flex space-x-2 items-center mb-6">
            <button id="btn-hu" class="px-4 py-2 rounded-md bg-blue-600 text-white">
                Magyar (HU)
            </button>
            <button id="btn-en" class="px-4 py-2 rounded-md bg-gray-200 text-gray-700 hover:bg-gray-300">
                English (EN)
            </button>
            <div class="flex-1"></div>
            <span id="status" class="text-sm text-green-700 bg-green-100 px-2 py-1 rounded">Mentve</span>
            <button id="btn-save" class="ml-2 px-3 py-2 rounded-md bg-blue-600 text-white disabled:opacity-50" disabled>
                Mentés
            </button>
            <button id="btn-discard" class="ml-2 px-3 py-2 rounded-md bg-gray-200 text-gray-700 disabled:opacity-50" disabled>
                Elvetés
            </button>
        </div>

        <!-- Translation Fields -->
        <div class="space-y-4">
            <div>
                <label for="landing_headline" class="block text-sm font-medium text-gray-700 mb-2">
                    Landing Page Headline
                </label>
                <input
                    type="text"
                    id="landing_headline"
                    name="landing_headline"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="Enter headline..."
                />
            </div>

            <div>
                <label for="cta_text" class="block text-sm font-medium text-gray-700 mb-2">
                    CTA Button Text
                </label>
                <input
                    type="text"
                    id="cta_text"
                    name="cta_text"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="Enter button text..."
                />
            </div>

            <div>
                <label for="meta_title" class="block text-sm font-medium text-gray-700 mb-2">
                    Meta Title
                </label>
                <input
                    type="text"
                    id="meta_title"
                    name="meta_title"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="Enter meta title..."
                />
            </div>

            <div>
                <label for="meta_description" class="block text-sm font-medium text-gray-700 mb-2">
                    Meta Description
                </label>
                <textarea
                    id="meta_description"
                    name="meta_description"
                    rows="3"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="Enter meta description..."
                ></textarea>
            </div>
        </div>

        <div class="text-sm text-gray-500 flex items-center gap-3 mt-6">
            <span>Current Language: <span id="current-lang">HU</span></span>
            <span>Quiz ID: <span id="quiz-id">-</span></span>
            <span>Változtatott mezők: <span id="changed-count">0</span></span>
        </div>
    </div>

    <script>
        // Get quiz ID from URL
        const urlParts = window.location.pathname.split('/');
        const quizId = urlParts[urlParts.indexOf('quizzes') + 1];
        document.getElementById('quiz-id').textContent = quizId;

        let currentLang = 'hu';
        let dirty = false;
        let changed = new Set();
        const fieldKeys = ['landing_headline', 'cta_text', 'meta_title', 'meta_description'];

        // Elements
        const btnHu = document.getElementById('btn-hu');
        const btnEn = document.getElementById('btn-en');
        const btnSave = document.getElementById('btn-save');
        const btnDiscard = document.getElementById('btn-discard');
        const status = document.getElementById('status');
        const currentLangSpan = document.getElementById('current-lang');
        const changedCount = document.getElementById('changed-count');

        // Load translations for current language
        async function loadTranslations() {
            try {
                const response = await fetch(`/api/admin/quizzes/${quizId}`);
                if (!response.ok) throw new Error('Failed to load quiz');
                
                const data = await response.json();
                const translations = data.translations || {};
                
                fieldKeys.forEach(key => {
                    const field = document.getElementById(key);
                    const langTranslations = translations[currentLang] || {};
                    field.value = langTranslations[key] || '';
                });
                
                setClean();
            } catch (error) {
                console.error('Error loading translations:', error);
                alert('Hiba a fordítások betöltésekor: ' + error.message);
            }
        }

        // Save translations
        async function saveTranslations() {
            if (!dirty) return;
            
            try {
                const translations = {};
                fieldKeys.forEach(key => {
                    const field = document.getElementById(key);
                    if (!translations[currentLang]) translations[currentLang] = {};
                    translations[currentLang][key] = field.value;
                });

                const response = await fetch(`/api/admin/quizzes/${quizId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ translations })
                });

                if (!response.ok) throw new Error('Failed to save');
                
                setClean();
                alert('Fordítások elmentve!');
            } catch (error) {
                console.error('Error saving translations:', error);
                alert('Mentési hiba: ' + error.message);
            }
        }

        // Mark field as changed
        function onFieldChange(fieldKey) {
            dirty = true;
            changed.add(fieldKey);
            updateUI();
        }

        // Update UI state
        function updateUI() {
            status.textContent = dirty ? 'Nem mentett módosítások' : 'Mentve';
            status.className = dirty ? 
                'text-sm text-amber-700 bg-amber-100 px-2 py-1 rounded' :
                'text-sm text-green-700 bg-green-100 px-2 py-1 rounded';
            
            btnSave.disabled = !dirty;
            btnDiscard.disabled = !dirty;
            changedCount.textContent = changed.size.toString();
        }

        // Set clean state
        function setClean() {
            dirty = false;
            changed.clear();
            updateUI();
        }

        // Switch language
        async function switchLanguage(lang) {
            if (dirty && !confirm('Nem mentett módosítások vannak. Elmentsem most?')) {
                return;
            }
            if (dirty) {
                await saveTranslations();
            }
            
            currentLang = lang;
            currentLangSpan.textContent = lang.toUpperCase();
            
            // Update button styles
            if (lang === 'hu') {
                btnHu.className = 'px-4 py-2 rounded-md bg-blue-600 text-white';
                btnEn.className = 'px-4 py-2 rounded-md bg-gray-200 text-gray-700 hover:bg-gray-300';
            } else {
                btnEn.className = 'px-4 py-2 rounded-md bg-blue-600 text-white';
                btnHu.className = 'px-4 py-2 rounded-md bg-gray-200 text-gray-700 hover:bg-gray-300';
            }
            
            await loadTranslations();
        }

        // Event listeners
        btnHu.addEventListener('click', () => switchLanguage('hu'));
        btnEn.addEventListener('click', () => switchLanguage('en'));
        btnSave.addEventListener('click', saveTranslations);
        btnDiscard.addEventListener('click', loadTranslations);

        // Add change listeners to all fields
        fieldKeys.forEach(key => {
            const field = document.getElementById(key);
            field.addEventListener('input', () => onFieldChange(key));
        });

        // Initial load
        loadTranslations();
    </script>
</body>
</html>
